<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sea to Summit, Summit 3</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">

<style>
html, body{
  margin:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:black;
  position:fixed;
  inset:0;
}
body{ touch-action: manipulation; }
*{ overscroll-behavior:none; }

.app{
  position:fixed;
  inset:0;
  background:black;
  overflow:hidden;
}

/* Stage scaling */
.stage-wrapper{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(1);
  transform-origin:center center;
  width:1920px;
  height:1080px;
}
.stage{
  position:relative;
  width:1920px;
  height:1080px;
}
.layer{
  position:absolute;
  left:0;
  top:0;
  width:1920px;
  height:1080px;
  image-rendering:pixelated;
  pointer-events:none;
}

/* Base scene */
.scene{ z-index:1; }

/* Clickable mushroom overlay */
.mushroom{
  position:absolute;
  left:0;
  top:0;
  width:1920px;
  height:1080px;
  image-rendering:pixelated;
  z-index:12;
  pointer-events:auto;
  cursor:default;
}

/* Subtle “something is off” pulse (very light) */
@keyframes shiver {
  0%   { transform: translate3d(0px,0px,0); opacity: 0.98; }
  50%  { transform: translate3d(0.6px,-0.4px,0); opacity: 1; }
  100% { transform: translate3d(0px,0px,0); opacity: 0.98; }
}
.mushroom.idle{
  animation: shiver 2.8s ease-in-out infinite;
}

/* Story */
.story{
  position:absolute;
  left:50%;
  bottom:180px;
  transform:translateX(-50%);
  width:900px;
  font-family:"Silkscreen";
  font-size:24px;
  line-height:1.2;
  color:black;
  opacity:1;
  z-index:25;
  padding: 0 50px;
  box-sizing:border-box;
  user-select:none;
}

/* Buttons */
.button{
  position:relative;
  cursor:pointer;
  display:inline-block;
}
.button img{
  width:420px;
  image-rendering:pixelated;
  display:block;
}
.button span{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  font-family:"Press Start 2P";
  font-size:18px;
  color:black;
  pointer-events:none;
  text-align:center;
  padding:0 14px;
  line-height:1.05;
}

/* Choices row */
.choices{
  position:absolute;
  left:50%;
  bottom:5px;
  transform:translateX(-50%);
  display:flex;
  gap:80px;
  align-items:center;
  justify-content:center;
  opacity:0;
  transition: opacity 700ms ease;
  z-index:30;
}
.choices.visible{ opacity:1; }

.choice-link{
  text-decoration:none;
  transform:scale(0.84);
  transform-origin:center center;
}

/* Abduction flash */
.flash{
  position:absolute;
  inset:0;
  z-index:90;
  pointer-events:none;
  background:white;
  opacity:0;
}
.flash.on{
  animation: flashOut 520ms ease-out forwards;
}
@keyframes flashOut{
  0%   { opacity:0; }
  15%  { opacity:1; }
  100% { opacity:0; }
}

/* Tiny glitch jitter on the whole stage during abduction */
.stage.abducting{
  animation: abductJitter 520ms steps(2,end) forwards;
}
@keyframes abductJitter{
  0%   { transform: translate3d(0,0,0); }
  20%  { transform: translate3d(2px,-1px,0); }
  40%  { transform: translate3d(-2px,1px,0); }
  60%  { transform: translate3d(1px,2px,0); }
  80%  { transform: translate3d(-1px,-2px,0); }
  100% { transform: translate3d(0,0,0); }
}
</style>
</head>

<body>
<div class="app">

  <div class="stage-wrapper" id="stageWrapper">
    <div class="stage" id="stage">
      <img class="layer scene" src="summit3.png" alt="">

      <!-- Mushroom overlay image (clickable) -->
      <img class="mushroom idle" id="mushroom" src="mushroom.png" alt="">

      <div class="story" id="story" aria-label="Story text"></div>

      <div class="choices" id="choices">
        <a class="choice-link" href="end.html" data-final="breath">
          <div class="button">
            <img src="stsbutton.png" alt="">
            <span>Take a deep breath</span>
          </div>
        </a>

        <a class="choice-link" href="end.html" data-final="eyes">
          <div class="button">
            <img src="stsbutton.png" alt="">
            <span>Close your eyes</span>
          </div>
        </a>

        <a class="choice-link" href="end.html" data-final="think">
          <div class="button">
            <img src="stsbutton.png" alt="">
            <span>Sit down and think</span>
          </div>
        </a>
      </div>

      <div class="flash" id="flash"></div>
    </div>
  </div>

  <!-- Persistent ambience (Option B) -->
  <audio id="waves" src="waves.mp3" preload="auto" loop></audio>

</div>

<script>
/* HARD scroll lock */
window.addEventListener("wheel", e => e.preventDefault(), { passive:false });
window.addEventListener("touchmove", e => e.preventDefault(), { passive:false });
window.addEventListener("keydown", e => {
  if (["ArrowUp","ArrowDown","Space","PageUp","PageDown"].includes(e.code)) e.preventDefault();
});

/* Stage scaling */
const stageWrapper = document.getElementById("stageWrapper");
function scaleStage(){
  const scale = Math.min(window.innerWidth / 1920, window.innerHeight / 1080);
  stageWrapper.style.transform = "translate(-50%, -50%) scale(" + scale + ")";
}
window.addEventListener("resize", scaleStage);
scaleStage();

/* Waves persistence (Option B) */
const waves = document.getElementById("waves");
const WAVE_TIME_KEY = "sts_waves_time_v1";
const WAVE_VOL_KEY  = "sts_waves_vol_v1";
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

function restoreWaves(){
  const savedVol = parseFloat(localStorage.getItem(WAVE_VOL_KEY));
  waves.volume = Number.isFinite(savedVol) ? clamp(savedVol, 0, 1) : 0.35;

  const savedT = parseFloat(localStorage.getItem(WAVE_TIME_KEY));
  if (Number.isFinite(savedT) && savedT > 0) {
    try { waves.currentTime = savedT; } catch (_) {}
  }

  const p = waves.play();
  if (p && typeof p.catch === "function") {
    p.catch(() => {
      const resume = () => {
        waves.play().catch(() => {});
        document.removeEventListener("click", resume, true);
      };
      document.addEventListener("click", resume, true);
    });
  }
}

function startSavingWaves(){
  setInterval(() => {
    if (!waves.paused && Number.isFinite(waves.currentTime)) {
      localStorage.setItem(WAVE_TIME_KEY, String(waves.currentTime));
      localStorage.setItem(WAVE_VOL_KEY, String(waves.volume));
    }
  }, 250);

  document.addEventListener("visibilitychange", () => {
    if (Number.isFinite(waves.currentTime)) {
      localStorage.setItem(WAVE_TIME_KEY, String(waves.currentTime));
      localStorage.setItem(WAVE_VOL_KEY, String(waves.volume));
    }
  });

  window.addEventListener("beforeunload", () => {
    if (Number.isFinite(waves.currentTime)) {
      localStorage.setItem(WAVE_TIME_KEY, String(waves.currentTime));
      localStorage.setItem(WAVE_VOL_KEY, String(waves.volume));
    }
  });
}
restoreWaves();
startSavingWaves();

/* Summit 3 story: click anywhere (not buttons/mushroom) to advance line-by-line */
const story = document.getElementById("story");
const choices = document.getElementById("choices");

const storyLines = [
  "The light shifts around you, faint and strange, as if the island itself is watching.",
  "The stillness deepens, wrapping around your heartbeat.",
  "Whatever happens next begins with you."
];

let lineIndex = 0;
let charIndex = 0;
let typing = null;
let isTyping = false;
let storyActive = true;

function startTypingLine(){
  clearInterval(typing);
  isTyping = true;
  charIndex = 0;
  story.textContent = "";
  const current = storyLines[lineIndex];

  typing = setInterval(() => {
    charIndex++;
    story.textContent = current.slice(0, charIndex);
    if (charIndex >= current.length) {
      clearInterval(typing);
      isTyping = false;
      if (lineIndex === storyLines.length - 1) {
        choices.classList.add("visible");
      }
    }
  }, 24);
}

function advanceStory(){
  if (!storyActive) return;

  if (isTyping) {
    clearInterval(typing);
    isTyping = false;
    story.textContent = storyLines[lineIndex];
    if (lineIndex === storyLines.length - 1) choices.classList.add("visible");
    return;
  }

  if (lineIndex < storyLines.length - 1) {
    lineIndex++;
    startTypingLine();
  }
}

document.addEventListener("click", (e) => {
  if (e.target.closest(".choice-link")) return;
  if (e.target.closest("#mushroom")) return;
  advanceStory();
});

/* Start immediately */
startTypingLine();

/* Save which final choice they picked (optional, for end.html to read) */
document.querySelectorAll(".choice-link").forEach(a => {
  a.addEventListener("click", () => {
    const v = a.getAttribute("data-final");
    localStorage.setItem("sts_final_choice_v1", v);
  });
});

/* Mushroom -> Alien abduction */
const mushroom = document.getElementById("mushroom");
const flash = document.getElementById("flash");
const stage = document.getElementById("stage");

let abducting = false;

mushroom.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  if (abducting) return;
  abducting = true;

  localStorage.setItem("sts_alien_triggered_v1", "1");

  // freeze clicks on choices during abduction
  document.querySelectorAll(".choice-link").forEach(a => a.style.pointerEvents = "none");
  mushroom.classList.remove("idle");

  stage.classList.add("abducting");
  flash.classList.add("on");

  setTimeout(() => {
    window.location.href = "alien1.html";
  }, 520);
});
</script>
</body>
</html>
