<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sea to Summit, Ending</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
  position: fixed;
  inset: 0;
}

body { touch-action: manipulation; }
* { overscroll-behavior: none; user-select: none; }

.app {
  position: fixed;
  inset: 0;
  background: black;
}

/* Stage */
.stage-wrapper {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 1920px;
  height: 1080px;
  transform: translate(-50%, -50%) scale(1);
  transform-origin: center;
}

.stage {
  position: relative;
  width: 1920px;
  height: 1080px;
}

/* Ending image */
.layer {
  position: absolute;
  inset: 0;
  width: 1920px;
  height: 1080px;
  image-rendering: pixelated;
  pointer-events: none;
  opacity: 0;
  transition: opacity 2200ms ease;
}
.layer.visible { opacity: 1; }
.layer.fade-out { opacity: 0; }

/* Text */
.story {
  position: absolute;
  left: 50%;
  bottom: 140px;
  transform: translateX(-50%);
  width: 1200px;

  font-family: "Silkscreen";
  font-size: 30px;
  line-height: 1.25;
  color: #e6e6e6;

  z-index: 25;
  min-height: 140px;
  padding: 0 40px;
  box-sizing: border-box;
  text-align: center;
}

.story-line {
  opacity: 0;
  transition: opacity 900ms ease;
}
.story-line.visible { opacity: 1; }

/* Button */
.actions {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  z-index: 30;
  opacity: 0;
  transition: opacity 1200ms ease;
}
.actions.visible { opacity: 1; }

.button {
  position: relative;
  cursor: pointer;
}
.button img {
  width: 520px;
  image-rendering: pixelated;
}
.button span {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-family: "Press Start 2P";
  font-size: 28px;
  color: black;
  pointer-events: none;
}

/* White fade */
.fade {
  position: absolute;
  inset: 0;
  background: white;
  opacity: 0;
  pointer-events: none;
  z-index: 999;
  transition: opacity 500ms ease;
}
.fade.on { opacity: 1; }
</style>
</head>

<body>
<div class="app">
  <div class="stage-wrapper" id="stageWrapper">
    <div class="stage">
      <img class="layer" id="endingImage" src="endi.png" alt="">

      <div class="story" id="story"></div>

      <div class="actions" id="actions">
        <a href="index.html" id="beginAgain">
          <div class="button">
            <img src="stsbutton.png">
            <span>Begin Again</span>
          </div>
        </a>
      </div>

      <div class="fade" id="fade"></div>
    </div>
  </div>

  <audio id="endSound" src="stsend.mp3" preload="auto"></audio>
</div>

<script>
/* Scale */
const stageWrapper = document.getElementById("stageWrapper");
function scaleStage() {
  const s = Math.min(window.innerWidth / 1920, window.innerHeight / 1080);
  stageWrapper.style.transform = "translate(-50%, -50%) scale(" + s + ")";
}
window.addEventListener("resize", scaleStage);
scaleStage();

/* Ending data */
const ENDINGS = {
  courage: [
    "You followed your instincts, even when it hurt to keep moving.",
    "What challenged you did not break you, it shaped you.",
    "You step forward now with a steadier kind of courage."
  ],
  compassion: [
    "You noticed what was fragile, and chose to help anyway.",
    "Kindness changed the shape of your path, quietly but forever.",
    "You carry that warmth into whatever comes next."
  ],
  wisdom: [
    "You knew when to pause, and when to continue.",
    "Rest did not stop you, it returned you to yourself.",
    "You leave the island with clearer eyes."
  ],
  curiosity: [
    "You reached for the unknown, and the unknown answered.",
    "Not every mystery is meant to be solved, but you listened closely.",
    "You move on with a brave, open mind."
  ],
  comfort: [
    "You found what was easy to stay inside.",
    "The island taught you that comfort can be a tide, not a home.",
    "When you are ready, you will choose forward."
  ],
  insight: [
    "You walked the shortest way, and felt what you missed.",
    "Knowing the path is not the same as knowing the world.",
    "Next time, you may look a little wider."
  ],
  rare: [
    "You walked every edge of the island, and the island remembered you.",
    "Each choice left a mark, each lesson returned as something new.",
    "This time, you do not begin again, you continue."
  ]
};

function num(k){ return parseFloat(localStorage.getItem(k)) || 0; }
function yes(k){ return localStorage.getItem(k) === "1"; }

function pickEndingKey() {
  if (
    yes("sts_done_beach") &&
    yes("sts_done_rocky") &&
    yes("sts_done_waterfall") &&
    yes("sts_done_cave") &&
    yes("sts_done_summit")
  ) return "rare";

  const scores = {
    courage: num("sts_courage"),
    compassion: num("sts_compassion"),
    wisdom: num("sts_wisdom"),
    curiosity: num("sts_curiosity"),
    comfort: num("sts_comfort")
  };

  let best = "insight";
  let max = -1;
  for (const k in scores) {
    if (scores[k] > max) {
      max = scores[k];
      best = k;
    }
  }
  return max > 0 ? best : "insight";
}

/* Setup */
const endingKey = pickEndingKey();
const lines = ENDINGS[endingKey];
const story = document.getElementById("story");
const image = document.getElementById("endingImage");
const actions = document.getElementById("actions");
const fade = document.getElementById("fade");
const sound = document.getElementById("endSound");

let index = 0;
let finished = false;

/* Build lines */
lines.forEach(text => {
  const div = document.createElement("div");
  div.className = "story-line";
  div.textContent = text;
  story.appendChild(div);
});

/* Start */
setTimeout(() => image.classList.add("visible"), 400);
sound.volume = 0.6;
sound.play().catch(()=>{});

/* Click anywhere to advance */
document.addEventListener("click", (e) => {
  if (e.target.closest("#beginAgain")) return;

  const items = document.querySelectorAll(".story-line");

  if (index < items.length) {
    items[index].classList.add("visible");
    index++;
    return;
  }

  if (!finished) {
    finished = true;
    image.classList.add("fade-out");
    actions.classList.add("visible");
  }
});

/* Begin Again */
document.getElementById("beginAgain").addEventListener("click", (e) => {
  e.preventDefault();
  fade.classList.add("on");

  for (let i = localStorage.length - 1; i >= 0; i--) {
    const k = localStorage.key(i);
    if (k && k.startsWith("sts_")) localStorage.removeItem(k);
  }

  setTimeout(() => {
    window.location.href = e.currentTarget.getAttribute("href");
  }, 520);
});
</script>
</body>
</html>
